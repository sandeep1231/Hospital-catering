<div class="container mt-3">
  <div class="mb-3 d-flex justify-content-between align-items-center">
    <h4 class="mb-0">Patients</h4>
    <div>
      <button class="btn btn-primary me-2" (click)="newPatient()" *ngIf="role !== 'dietician'">New Patient</button>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-2 align-items-center">
      <div class="col-12 col-lg-4">
        <div class="input-group">
          <input class="form-control" placeholder="Search by name or phone" [(ngModel)]="q" (keyup.enter)="page=1; load()" />
          <button class="btn btn-outline-secondary" (click)="page=1; load()" title="Search" aria-label="Search">üîç</button>
        </div>
      </div>
      <div class="col-6 col-lg-2">
        <select class="form-select" [(ngModel)]="status" (change)="page=1; load()">
          <option value="">All patients</option>
          <option value="in_patient">In-patient</option>
          <option value="discharged">Discharged</option>
          <option value="outpatient">Outpatient</option>
        </select>
      </div>
      <div class="col-6 col-lg-2">
        <select class="form-select" [(ngModel)]="dietStatus" (change)="page=1; load()">
          <option value="">All diet statuses</option>
          <option value="pending">Diet: Pending</option>
          <option value="delivered">Diet: Delivered</option>
          <option value="cancelled">Diet: Cancelled</option>
        </select>
      </div>
      <div class="col-6 col-lg-2">
        <select class="form-select" [(ngModel)]="roomTypeFilter" (change)="onRoomTypeChange()">
          <option value="">Room type</option>
          <option *ngFor="let rt of roomTypes" [value]="rt">{{rt}}</option>
        </select>
      </div>
      <div class="col-6 col-lg-2">
        <select class="form-select" [(ngModel)]="roomNoFilter" (change)="page=1; load()">
          <option value="">Room no</option>
          <option *ngFor="let rn of roomNos" [value]="rn">{{rn}}</option>
        </select>
      </div>
      <div class="col-12 col-lg-2 d-grid d-lg-block text-end">
        <button class="btn btn-outline-secondary w-100 w-lg-auto" (click)="q=''; status=''; dietStatus=''; roomTypeFilter=''; roomNoFilter=''; page=1; load()">Reset</button>
      </div>
    </div>
  </div>

  <!-- Removed dedicated skeleton block; use in-place skeleton rows/cards for near-zero shift -->

  <div *ngIf="!loading && patients.length === 0" class="alert alert-light">No patients found</div>

  <!-- Desktop: table in card with sticky header and scroll -->
  <div class="card d-none d-lg-block">
    <div class="card-body p-0">
      <div class="table-container table-responsive">
        <table class="table table-sm align-middle table-sticky mb-0">
          <thead>
            <tr>
              <th>Date</th>
              <th>Name</th>
              <th>Phone</th>
              <th>Room</th>
              <th>Bed No.</th>
              <th>Patient Type</th>
              <th>Diet (history)</th>
              <th class="text-end">Action</th>
            </tr>
          </thead>
          <tbody [class.placeholder-glow]="loading">
            <!-- Skeleton rows while loading -->
            <ng-container *ngIf="loading; else patientRows">
              <tr *ngFor="let i of [1,2,3,4,5,6,7,8,9,10]">
                <td><span class="placeholder col-6"></span></td>
                <td>
                  <div class="placeholder col-8 mb-1"></div>
                  <div class="placeholder col-4"></div>
                </td>
                <td><span class="placeholder col-7"></span></td>
                <td><span class="placeholder col-8"></span></td>
                <td><span class="placeholder col-4"></span></td>
                <td><span class="placeholder col-6"></span></td>
                <td><div class="placeholder col-10"></div></td>
                <td class="text-end"><span class="placeholder col-5"></span></td>
              </tr>
            </ng-container>
            <!-- Real rows -->
            <ng-template #patientRows>
            <tr *ngFor="let p of patients">
              <td>
                {{ (p.inDate || p.createdAt) | date:'dd-MM-yyyy':'Asia/Kolkata' }}
              </td>
              <td>
                <div class="fw-medium">{{p.name}}</div>
                <div class="small text-muted">Age: {{p.age || '‚Äî'}}</div>
              </td>
              <td>{{p.phone || '‚Äî'}}</td>
              <td>{{p.roomType || '‚Äî'}} / {{p.roomNo || '‚Äî'}}</td>
              <td>{{p.bed || '‚Äî'}}</td>
              <td>
                <span class="badge bg-secondary" *ngIf="p.status==='in_patient'">In-patient</span>
                <span class="badge bg-success" *ngIf="p.status==='discharged'">Discharged</span>
                <span class="badge bg-info text-dark" *ngIf="p.status==='outpatient'">Outpatient</span>
              </td>
              <td>
                <!-- Compact history list -->
                <div class="small text-muted" *ngIf="sortedHistory(p)?.length">
                  <div *ngFor="let h of sortedHistory(p)">
                    <span>{{ h.date | date:'dd-MM-yyyy':'Asia/Kolkata' }}:</span>
                    <span class="ms-1">{{ h.diet }}</span>
                    <span class="badge ms-1" [ngClass]="{
                      'bg-success': h.status==='delivered',
                      'bg-warning text-dark': h.status==='pending',
                      'bg-secondary': h.status==='cancelled'
                    }">{{ h.status }}</span>
                  </div>
                </div>
              </td>
              <td class="text-end">
                <button class="btn btn-sm btn-outline-primary me-2" (click)="open(p)" title="View / Edit">
                  View
                </button>
                <button *ngIf="role==='admin'" class="btn btn-sm btn-outline-danger" (click)="delete(p)" title="Delete">
                  Delete
                </button>
              </td>
            </tr>
            </ng-template>
          </tbody>
        </table>
      </div>
    </div>
    <div class="card-footer d-flex justify-content-between align-items-center" *ngIf="!loading">
      <div class="small text-muted">
        Showing {{ (patients.length ? ((page-1)*pageSize + 1) : 0) }}
        to {{ ((page-1)*pageSize + patients.length) }} of {{ total }}
      </div>
      <div class="d-flex align-items-center gap-2">
        <select class="form-select form-select-sm w-auto" [ngModel]="pageSize" (ngModelChange)="onPageSizeChange($event)">
          <option [ngValue]="10">10</option>
          <option [ngValue]="20">20</option>
          <option [ngValue]="50">50</option>
          <option [ngValue]="100">100</option>
        </select>
        <div class="btn-group">
          <button class="btn btn-sm btn-outline-secondary" (click)="prevPage()" [disabled]="!canPrev()">Prev</button>
          <button class="btn btn-sm btn-outline-secondary" (click)="nextPage()" [disabled]="!canNext()">Next</button>
        </div>
        <div class="small text-muted">Page {{page}} / {{ totalPages() }}</div>
      </div>
    </div>
  </div>

  <!-- Mobile/Tablet: card view with icons -->
  <div class="d-lg-none">
    <div class="row g-2">
      <!-- Skeleton cards while loading -->
      <ng-container *ngIf="loading; else patientCards">
        <div class="col-12" *ngFor="let i of [1,2,3,4,5]">
          <div class="card">
            <div class="card-body placeholder-glow">
              <div class="d-flex justify-content-between align-items-start">
                <div class="w-75">
                  <div class="placeholder col-5 mb-2"></div>
                  <div class="placeholder col-7"></div>
                </div>
                <div class="w-25 text-end">
                  <div class="placeholder col-6 mb-2"></div>
                  <div class="placeholder col-6"></div>
                </div>
              </div>
              <div class="placeholder col-8 mt-2"></div>
              <div class="placeholder col-6 mt-2"></div>
              <div class="placeholder col-5 mt-2"></div>
              <div class="placeholder col-7 mt-2"></div>
            </div>
          </div>
        </div>
      </ng-container>
      <!-- Real cards -->
      <ng-template #patientCards>
      <div class="col-12" *ngFor="let p of patients">
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="small text-muted">Date: {{ (p.inDate || p.createdAt) | date:'dd-MM-yyyy':'Asia/Kolkata' }}</div>
                <div class="fw-semibold">{{p.name}}</div>
              </div>
              <div class="d-flex align-items-center gap-2">
                <button class="btn btn-sm btn-outline-primary" (click)="open(p)" title="Edit / View" aria-label="Edit">‚úèÔ∏è</button>
                <button *ngIf="role==='admin'" class="btn btn-sm btn-outline-danger" (click)="delete(p)" title="Delete" aria-label="Delete">üóëÔ∏è</button>
              </div>
            </div>
            <div class="small text-muted mt-1"><strong>Phone:</strong> {{p.phone || '‚Äî'}}</div>
            <div class="small text-muted mt-1"><strong>Room:</strong> {{p.roomType || '‚Äî'}} / {{p.roomNo || '‚Äî'}}</div>
            <div class="small text-muted mt-1"><strong>Bed No.:</strong> {{p.bed || '‚Äî'}}</div>
            <div class="small mt-1">
              <strong>Patient Type:</strong>
              <span class="badge bg-secondary ms-1" *ngIf="p.status==='in_patient'">In-patient</span>
              <span class="badge bg-success ms-1" *ngIf="p.status==='discharged'">Discharged</span>
              <span class="badge bg-info text-dark ms-1" *ngIf="p.status==='outpatient'">Outpatient</span>
            </div>
            <div class="small mt-2">
              <div class="fw-semibold">Diet (history)</div>
              <ng-container *ngIf="sortedHistory(p)?.length as histLen">
                <div class="small text-muted mt-1">
                  <ng-container *ngFor="let h of sortedHistory(p) | slice:0:(isHistoryExpanded(p) ? histLen : 5)">
                    <div>
                      {{ h.date | date:'dd-MM-yyyy':'Asia/Kolkata' }}: {{ h.diet }}
                      <span class="badge ms-1" [ngClass]="{
                        'bg-success': h.status==='delivered',
                        'bg-warning text-dark': h.status==='pending',
                        'bg-secondary': h.status==='cancelled'
                      }">{{ h.status }}</span>
                    </div>
                  </ng-container>
                </div>
                <div class="mt-1" *ngIf="histLen > 5">
                  <button class="btn btn-link btn-sm p-0" (click)="toggleHistory(p)">
                    {{ isHistoryExpanded(p) ? 'Show less' : 'Show more' }}
                  </button>
                </div>
              </ng-container>
            </div>
          </div>
        </div>
      </div>
      </ng-template>
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mt-2">
          <div class="small text-muted">
            Showing {{ (patients.length ? ((page-1)*pageSize + 1) : 0) }}
            to {{ ((page-1)*pageSize + patients.length) }} of {{ total }}
          </div>
          <div class="d-flex align-items-center gap-2">
            <select class="form-select form-select-sm w-auto" [ngModel]="pageSize" (ngModelChange)="onPageSizeChange($event)">
              <option [ngValue]="10">10</option>
              <option [ngValue]="20">20</option>
              <option [ngValue]="50">50</option>
              <option [ngValue]="100">100</option>
            </select>
            <div class="btn-group">
              <button class="btn btn-sm btn-outline-secondary" (click)="prevPage()" [disabled]="!canPrev()">Prev</button>
              <button class="btn btn-sm btn-outline-secondary" (click)="nextPage()" [disabled]="!canNext()">Next</button>
            </div>
            <div class="small text-muted">Page {{page}} / {{ totalPages() }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
